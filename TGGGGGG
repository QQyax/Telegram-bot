import os
import telegram
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters
import logging

# é…ç½®æ—¥å¿—è®°å½•
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# Bot configuration
DEBUG = os.environ.get("DEBUG", "False").lower() == "true"
# å‡è®¾è¿™é‡Œç»´æŠ¤ä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·IDåˆ—è¡¨ï¼Œå®é™…ä½¿ç”¨ä¸­éœ€æ ¹æ®æƒ…å†µåŠ¨æ€ç»´æŠ¤
ADMIN_USER_IDS = [123456, 789012]  # ç¤ºä¾‹ç®¡ç†å‘˜ç”¨æˆ·ID

# ä»ç¯å¢ƒå˜é‡ä¸­è·å–æœºå™¨äººAPIå¯†é’¥ï¼Œå»ºè®®å®é™…è¿è¡Œæ—¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡
TELEGRAM_BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
if not TELEGRAM_BOT_TOKEN:
    raise ValueError("TELEGRAM_BOT_TOKEN environment variable is not set.")

# Default responses
DEFAULT_WELCOME_MESSAGE = """<b>æ‚¨å¥½ï¼Œæ¬¢è¿åŠ å…¥ï¼</b>
è¯·é˜…è¯»ç¾¤è§„å¹¶äº«å—æ‚¨çš„æ—¶å…‰ã€‚
å¦‚éœ€å¸®åŠ©è¯·è”ç³»ç¾¤ç®¡ç†å‘˜ã€‚"""
DEFAULT_HELP_MESSAGE = """
å¯ç”¨å‘½ä»¤ï¼š
/start - å¯åŠ¨æœºå™¨äººå¹¶è·å–æ¬¢è¿ä¿¡æ¯
/help - æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯
/ban <ç”¨æˆ·åæˆ–ç”¨æˆ·ID> - å°ç¦æŒ‡å®šç”¨æˆ·
/stats - æ˜¾ç¤ºç¾¤ç»„ç»Ÿè®¡ä¿¡æ¯
/auto_reply <å…³é”®è¯> <å›å¤å†…å®¹> - è®¾ç½®è‡ªåŠ¨å›å¤
"""

# Keyword responses - å¯ä»¥åœ¨æ­¤å¤„æ·»åŠ è‡ªå®šä¹‰å…³é”®è¯å“åº”ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
ADDITIONAL_KEYWORD_RESPONSES = {
    "éªŒç¾¤": "æœ¬ç¾¤æ˜¯çœŸç¾¤ï¼è¯·æ³¨æ„çœ‹æˆ‘çš„ç”¨æˆ·åæ˜¯ @qunguan (ç¾¤ç®¡æ‹¼éŸ³)ï¼Œè°¨é˜²å‡æœºå™¨äººã€‚ç§èŠæˆ‘è¾“å…¥è¯è¯­å¯ä»¥æœç´¢çœŸå…¬ç¾¤,å¦‚ï¼šå¡å•†ã€ç™½èµ„ã€æ‰¿å…‘ç­‰ã€‚è¯·æ‰¾[...]",
    "çœŸç¾¤": "æœ¬ç¾¤æ˜¯çœŸç¾¤ï¼è¯·æ³¨æ„è¾¨åˆ«çœŸå‡ï¼Œè°¨é˜²è¯ˆéª—ã€‚è¯·æ‰¾æœ‰å¤´åƒçš„ç¾¤ç®¡ç†å‘˜äº¤æ˜“ï¼Œåˆ‡å‹¿ç›¸ä¿¡ä¸»åŠ¨ç§èŠä½ çš„ç”¨æˆ·ã€‚",
    "é˜²éª—": "é˜²éª—æç¤ºï¼š1. ä¸è¦è½»ä¿¡ä¸»åŠ¨ç§èŠçš„é™Œç”Ÿäºº 2. äº¤æ˜“å‰æ ¸å®å¯¹æ–¹èº«ä»½ 3. ä½¿ç”¨å®‰å…¨çš„æ”¯ä»˜æ–¹å¼ 4. é‡è¦äº¤æ˜“è¯·é€šè¿‡ç¾¤å†…æœ‰å¤´åƒçš„ç®¡ç†å‘˜è¿›è¡Œ 5. é‡[...]",
    "ç¦è¨€": "æœ¬ç¾¤å·²ç¦è¨€ï¼Œå¼€ç¾¤ç­‰å¾…ç®¡ç†å‘˜é€šçŸ¥",
    "è§£é™¤ç¦è¨€": "æœ¬ç¾¤å·²è§£é™¤ç¦è¨€ï¼Œç»§ç»­æ­£å¸¸è¥ä¸š",
    "å…¬ç¾¤å¯¼èˆª": "å…¬ç¾¤å¯¼èˆª @hwgq é¿å…è¿›å‡ç¾¤\nå…¬ç¾¤æµç¨‹ @gongqunLC äº†è§£å…¬ç¾¤äº¤æ˜“æ³¨æ„äº‹é¡¹\nå®¢æœé¢‘é“ @kefu å¯ä»¥å¿«é€Ÿåˆ†è¾¨å·¥ä½œäººå‘˜\n\nå¦å¤–å¯ä»¥ç§èŠæˆ‘å‘é€å…¬[...]",
    "å®˜æ–¹é¢‘é“": "å…¬ç¾¤å¯¼èˆª @hwgq\nå…¬ç¾¤æµç¨‹ @gongqunLC\nå®¢æœé¢‘é“ @kefu\n\nè¯·è®¤å‡†å®˜æ–¹é¢‘é“ï¼Œé¿å…è¢«å‡å†’è´¦å·è¯ˆéª—ã€‚æ‚¨å¯ä»¥ç§èŠæˆ‘è¿›è¡Œç¾¤ç»„æœç´¢æˆ–å¯¼èˆªã€‚",
    "å®¢æœ": "æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘ä»¬çš„å®¢æœï¼š\nå®¢æœé¢‘é“ @kefu\n\nè¯·æ³¨æ„è¾¨åˆ«çœŸå‡å®¢æœï¼Œå®˜æ–¹å®¢æœä¸ä¼šä¸»åŠ¨ç§èŠæ‚¨ï¼Œä¹Ÿä¸ä¼šè¦æ±‚æ‚¨å…ˆä»˜æ¬¾ã€‚",
    "ç¾¤ä»‹ç»": "è¿™æ˜¯ä¸€ä¸ªå‹å¥½çš„äº¤æµç¾¤ï¼Œæˆ‘ä»¬æ¬¢è¿å¤§å®¶åˆ†äº«çŸ¥è¯†å’Œç»éªŒã€‚è¯·éµå®ˆç¾¤è§„ï¼Œå…±åŒç»´æŠ¤è‰¯å¥½çš„äº¤æµç¯å¢ƒã€‚",
    "å¦‚ä½•æé—®": "è¯·ç›´æ¥æè¿°ä½ çš„é—®é¢˜ï¼Œå°½é‡æä¾›å®Œæ•´çš„ä¿¡æ¯ï¼Œè¿™æ ·æ›´å®¹æ˜“å¾—åˆ°æœ‰æ•ˆçš„å›ç­”ã€‚é¿å…'æœ‰äººæ‡‚å—'è¿™ç±»æ¨¡ç³Šçš„æé—®æ–¹å¼ã€‚",
    "å‘é€æ–‡ä»¶": "å¯ä»¥ç›´æ¥åœ¨ç¾¤é‡Œå‘é€å›¾ç‰‡å’Œæ–‡ä»¶ï¼Œä½†è¯·æ³¨æ„æ–‡ä»¶å¤§å°é™åˆ¶ï¼Œå¤§æ–‡ä»¶å»ºè®®ä½¿ç”¨ç½‘ç›˜é“¾æ¥åˆ†äº«ã€‚",
    "å¸¸è§é—®é¢˜": "è¯·æŸ¥çœ‹ç¾¤ç½®é¡¶æ¶ˆæ¯ä¸­çš„FAQæ–‡æ¡£ï¼Œé‚£é‡Œæœ‰å¾ˆå¤šå¸¸è§é—®é¢˜çš„è§£ç­”ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä½ éœ€è¦çš„ä¿¡æ¯ï¼Œå¯ä»¥åœ¨ç¾¤é‡Œæé—®ã€‚",
    "æ•™ç¨‹": "æˆ‘ä»¬æœ‰ä¸€ç³»åˆ—æ•™ç¨‹å¯ä¾›å‚è€ƒï¼Œè¯·æŸ¥çœ‹ç¾¤å…¬å‘Šæˆ–è”ç³»ç®¡ç†å‘˜è·å–ç›¸å…³é“¾æ¥ã€‚",
    "æ–‡æ¡£": "å®˜æ–¹æ–‡æ¡£æ˜¯æœ€æƒå¨çš„å‚è€ƒèµ„æ–™ï¼Œå»ºè®®å…ˆæŸ¥é˜…æ–‡æ¡£ï¼Œå†æå‡ºå…·ä½“é—®é¢˜ã€‚",
    "æ–°äººæŒ‡å—": "æ¬¢è¿åŠ å…¥ï¼è¯·å…ˆé˜…è¯»ç¾¤è§„ï¼Œç„¶åå¯ä»¥ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªå·±ã€‚å¦‚æœ‰é—®é¢˜éšæ—¶æå‡ºï¼Œæˆ‘ä»¬ä¼šå°½åŠ›å¸®åŠ©ä½ ã€‚",
    "çŒæ°´": "é€‚å½“çš„é—²èŠæ˜¯å…è®¸çš„ï¼Œä½†è¯·é¿å…è¿‡åº¦çŒæ°´ï¼Œä¿æŒç¾¤ç»„çš„ä¸»è¦è®¨è®ºæ–¹å‘ã€‚",
    "ä¸­ç§‹": "ä¸­ç§‹èŠ‚å¿«ä¹ï¼æ„¿ä½ å’Œå®¶äººå›¢å›¢åœ†åœ†ï¼Œå¹¸ç¦ç¾æ»¡ï¼ğŸ¥®ğŸŒ•",
    "å›½åº†": "ç¥å¤§å®¶å›½åº†èŠ‚å¿«ä¹ï¼ğŸ‰",
    "é™¤å¤•": "é™¤å¤•å¿«ä¹ï¼ç¥å¤§å®¶æ–°å¹´å¿«ä¹ï¼Œä¸‡äº‹å¦‚æ„ï¼ğŸ§§",
    "æ— èŠ": "è¦ä¸æ¥èŠèŠä½ æœ€è¿‘å­¦åˆ°çš„æœ‰è¶£çŸ¥è¯†ï¼Ÿæˆ–è€…åˆ†äº«ä¸€ä¸‹ä½ çš„å…´è¶£çˆ±å¥½ï¼Ÿ",
    "ä¸‹ç­äº†": "ç»ˆäºç­‰åˆ°è¿™ä¸€åˆ»ï¼ç¥ä½ æœ‰ä¸ªæ„‰å¿«çš„ä¸‹ç­æ—¶å…‰ï½ğŸ‰",
    "å›°äº†": "ä¼‘æ¯ä¸€ä¸‹å§ï¼Œæ³¨æ„åŠ³é€¸ç»“åˆæ‰èƒ½æ›´æœ‰æ•ˆç‡å“¦ï¼",
    "é¥¿äº†": "æ˜¯æ—¶å€™çŠ’åŠ³ä¸€ä¸‹è‡ªå·±ï¼Œæ¥é¡¿ç¾é£Ÿå§ï¼ğŸœ",
    "ä½ å¥½": "ä½ å¥½å‘€ï¼å¾ˆé«˜å…´å’Œä½ äº¤æµï¼Œæœ‰ä»€ä¹ˆé—®é¢˜éƒ½å¯ä»¥é—®æˆ‘å“¦ã€‚"
}

# ç§èŠæ¬¢è¿æ¶ˆæ¯ - å®Œå…¨åŒ¹é…æˆªå›¾ä¸­çš„æ–‡æœ¬å’Œæ ·å¼
PRIVATE_CHAT_WELCOME = """è¿™é‡Œæ˜¯å¥½æ—ºå…¬ç¾¤æœºå™¨äºº
å…¬ç¾¤å¯¼èˆª @hwgq é¿å…è¿›å‡ç¾¤
å…¬ç¾¤æµç¨‹ @gongqunLC äº†è§£å…¬ç¾¤äº¤æ˜“æ³¨æ„äº‹é¡¹
å®¢æœé¢‘é“ @kefu å¯ä»¥å¿«é€Ÿåˆ†è¾¨å·¥ä½œäººå‘˜
å¦å¤–å¯ä»¥ç§èŠæˆ‘å‘é€å…¬ç¾¤ç¼–å·ç›´æ¥è·å–è¿›ç¾¤æ–¹å¼ï¼Œä¾‹å¦‚ã€123ã€‘ï¼›ä¹Ÿå¯ä»¥è¾“å…¥è¯è¯­è¿›è¡Œæœç´¢ï¼Œå¦‚ å¡å•†ã€ä»£æ”¶ã€ç™½èµ„
https://t.me/hwgq"""

# é¢‘é“ä»‹ç»æ¶ˆæ¯ - åŒ¹é…æˆªå›¾ä¸­çš„æ ·å¼
CHANNEL_INFO = """<b>Telegram</b>
å¥½æ—ºå…¬ç¾¤ @hwgq
ä¾›æ±‚ä¿¡æ¯ @hwtb2
æ–°å¼€å…¬ç¾¤ @xinqun
æ ¸å¿ƒå¤§ç¾¤ @daqun
é˜²éª—æŒ‡å— @hwtb22
æ‹…ä¿æ•™ç¨‹ @hwtb33
è”ç³»å¥½æ—ºæ‹…ä¿ @hwdb"""

# ç¾¤ç»„æœç´¢æ•°æ®åº“
GROUP_DATABASE = {
    "æ•°å­—ç¼–å·": {
        "001": {
            "name": "å¥½æ—ºå®˜æ–¹å…¬ç¾¤",
            "link": "https://t.me/+hwgq001",
            "description": "å¥½æ—ºå®˜æ–¹è®¤è¯å…¬ç¾¤ï¼Œå®‰å…¨å¯é ã€‚",
            "create_time": "2023-01-01",
            "member_count": 100
        },
        "123": {
            "name": "å¡å•†äº¤æµç¾¤",
            "link": "https://t.me/+abcdefg123456",
            "description": "å¡å•†äº¤æµä¸æœåŠ¡ï¼Œä¸¥ç¦å¹¿å‘Šï¼Œç®¡ç†ä¸¥æ ¼ã€‚",
            "create_time": "2023-02-01",
            "member_count": 80
        },
        "168": {
            "name": "å¥½æ—ºç™½èµ„ç¾¤",
            "link": "https://t.me/+hwbaizi168",
            "description": "å¥½æ—ºå®˜æ–¹ç™½èµ„äº¤æµç¾¤ï¼Œä¸“ä¸šå¯é ã€‚",
            "create_time": "2023-03-01",
            "member_count": 60
        },
        "188": {
            "name": "å¥½æ—ºæ‰¿å…‘ç¾¤",
            "link": "https://t.me/+hwchengdui188",
            "description": "å¥½æ—ºå®˜æ–¹æ‰¿å…‘æœåŠ¡ç¾¤ï¼Œå®‰å…¨æœ‰ä¿éšœã€‚",
            "create_time": "2023-04-01",
            "member_count": 70
        },
        "199": {
            "name": "å¥½æ—ºä»£æ”¶ä»˜ç¾¤",
            "link": "https://t.me/+hwdaishoufu199",
            "description": "å¥½æ—ºå®˜æ–¹ä»£æ”¶ä»£ä»˜ç¾¤ï¼Œå®‰å…¨æœ‰ä¿éšœã€‚",
            "create_time": "2023-05-01",
            "member_count": 90
        },
        "234": {
            "name": "æ‰¿å…‘æœåŠ¡ç¾¤",
            "link": "https://t.me/+bcdefgh234567",
            "description": "ä¸“ä¸šæ‰¿å…‘æœåŠ¡ï¼Œè¯·è®¤å‡†å®˜æ–¹æ¸ é“ã€‚",
            "create_time": "2023-06-01",
            "member_count": 50
        },
        "345": {
            "name": "ä»£æ”¶ä»£ä»˜ç¾¤",
            "link": "https://t.me/+cdefghi345678",
            "description": "ä»£æ”¶ä»£ä»˜ä¸šåŠ¡äº¤æµç¾¤ï¼Œç®¡ç†å‘˜ç»Ÿä¸€æœ‰è®¤è¯æ ‡è¯†ã€‚",
            "create_time": "2023-07-01",
            "member_count": 65
        },
        "456": {
            "name": "ç™½èµ„äº¤æµç¾¤",
            "link": "https://t.me/+defghij456789",
            "description": "ç™½èµ„ä¸šåŠ¡äº¤æµç¾¤ï¼Œæ³¨æ„é˜²èŒƒé£é™©ã€‚",
            "create_time": "2023-08-01",
            "member_count": 40
        },
        "666": {
            "name": "å¥½æ—ºæ ¸å¿ƒå¤§ç¾¤",
            "link": "https://t.me/+hwdaqun666",
            "description": "å¥½æ—ºå®˜æ–¹æ ¸å¿ƒå¤§ç¾¤ï¼Œä¿¡æ¯å…¨é¢ï¼Œç®¡ç†ä¸¥æ ¼ã€‚",
            "create_time": "2023-09-01",
            "member_count": 120
        },
        "789": {
            "name": "å•†å®¶è”ç›Ÿç¾¤",
            "link": "https://t.me/+efghijk789012",
            "description": "å•†å®¶èµ„æºæ•´åˆäº¤æµç¾¤ï¼Œä»…é™è®¤è¯å•†å®¶ã€‚",
            "create_time": "2023-10-01",
            "member_count": 75
        },
        "888": {
            "name": "å¥½æ—ºå•†å®¶ç¾¤",
            "link": "https://t.me/+hwshj888",
            "description": "å¥½æ—ºå®˜æ–¹å•†å®¶ç¾¤ï¼Œä¸“ä¸šè®¤è¯å•†å®¶å¯åŠ å…¥ã€‚",
            "create_time": "2023-11-01",
            "member_count": 85
        }
    },
    "å…³é”®è¯": {
        "å¥½æ—º": ["001", "168", "188", "199", "666", "888"],
        "å¡å•†": ["123", "789"],
        "æ‰¿å…‘": ["188", "234"],
        "ä»£æ”¶": ["199", "345"],
        "ä»£ä»˜": ["199", "345"],
        "ç™½èµ„": ["168", "456"],
        "å•†å®¶": ["789", "888"],
        "è”ç›Ÿ": ["789"],
        "æ ¸å¿ƒ": ["666"],
        "å¤§ç¾¤": ["666"]
    }
}


# æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ‰§è¡Œæ“ä½œçš„æƒé™
def check_permission(user_id):
    return user_id in ADMIN_USER_IDS


# å¤„ç†/startå‘½ä»¤
def start(update, context):
    context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=DEFAULT_WELCOME_MESSAGE,
        parse_mode=telegram.ParseMode.HTML
    )


# å¤„ç†/helpå‘½ä»¤
def help_command(update, context):
    context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=DEFAULT_HELP_MESSAGE,
        parse_mode=telegram.ParseMode.HTML
    )


# å¤„ç†è‡ªåŠ¨å›å¤å‘½ä»¤ /auto_reply <å…³é”®è¯> <å›å¤å†…å®¹>
def auto_reply(update, context):
    if check_permission(update.effective_user.id):
        if len(context.args) < 2:
            context.bot.send_message(chat_id=update.effective_chat.id, text="ç”¨æ³•: /auto_reply <å…³é”®è¯> <å›å¤å†…å®¹>")
            return
        keyword = context.args[0].lower()
        reply = " ".join(context.args[1:])
        ADDITIONAL_KEYWORD_RESPONSES[keyword] = reply
        context.bot.send_message(chat_id=update.effective_chat.id, text=f"è‡ªåŠ¨å›å¤å·²è®¾ç½®: {keyword} -> {reply}")
    else:
        context.bot.send_message(chat_id=update.effective_chat.id, text="ä½ æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œã€‚")


# å¤„ç†æ™®é€šæ¶ˆæ¯
def handle_message(update, context):
    text = update.message.text.lower()
    response = ADDITIONAL_KEYWORD_RESPONSES.get(text)
    if response:
        context.bot.send_message(chat_id=update.effective_chat.id, text=response)
    else:
        context.bot.send_message(chat_id=update.effective_chat.id, text="æˆ‘ä¸å¤ªç†è§£ä½ çš„æ„æ€å“¦ã€‚")


def main():
    try:
        # åˆå§‹åŒ–æœºå™¨äºº
        updater = Updater(token=TELEGRAM_BOT_TOKEN, use_context=True)
        dispatcher = updater.dispatcher

        # æ·»åŠ å‘½ä»¤å¤„ç†ç¨‹åº
        start_handler = CommandHandler('start', start)
        dispatcher.add_handler(start_handler)

        help_handler = CommandHandler('help', help_command)
        dispatcher.add_handler(help_handler)

        auto_reply_handler = CommandHandler('auto_reply', auto_reply)
        dispatcher.add_handler(auto_reply_handler)

        # æ·»åŠ æ¶ˆæ¯å¤„ç†ç¨‹åº
        message_handler = MessageHandler(Filters.text & (~Filters.command), handle_message)
        dispatcher.add_handler(message_handler)

        # å¯åŠ¨æœºå™¨äºº
        updater.start_polling()
        logging.info("Bot started polling.")
        updater.idle()
    except Exception as e:
        logging.error(f"An error occurred: {e}")


if __name__ == "__main__":
    main()
